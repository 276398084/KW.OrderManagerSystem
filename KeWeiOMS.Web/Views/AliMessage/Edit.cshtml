@model KeWeiOMS.Domain.AliMessageType
@{
  
}
<style type="text/css">
    dd, div, dl, dt {
        margin: 0;
    }

    dl {
        display: block;
        -webkit-margin-before: 1em;
        -webkit-margin-after: 1em;
        -webkit-margin-start: 0px;
        -webkit-margin-end: 0px;
    }

    dt {
        display: block;
    }

    .message-list-item dt {
        float: left;
        padding: 1px 5px 0 10px;
        width: 70px;
        height: 50px;
        word-wrap: break-word;
        overflow: hidden;
        line-height: 25px;
        color: #06c;
    }

    .message-list-item dd {
        margin-left: 85px;
        padding: 1px 10px 0 0;
    }

        .message-list-item dd .date {
            line-height: 25px;
            font-size: 11px;
            color: #999;
        }

        .message-list-item dd .msg-content {
            padding-bottom: 6px;
            line-height: 22px;
            color: #333;
        }
</style>
<script type="text/javascript">
    $(function () {
        //这里写加载下拉列表、修改编辑控件的初始化值

        $('#order').datagrid({
            url: '@Url.Action("GetOrder", "AliMessage")',
            nowrap: false,
            queryParams: { v: "@Model.SenderName" },
            detailFormatter: function (index, row) {
                var html = '<div id="ddv-' + index + '" style="padding:5px 0"></div>';
                html += '<div  style="padding:5px 0"><b>留言:' + row.BuyerMemo + '</b></div>';
                return html;
            },
            onDblClickRow: function (i, r) {
                window.open('@Url.Action("Edit", "Order")/' + r.Id);
            },
            onExpandRow: function (index, row) {
                $('#ddv-' + index).panel({
                    border: false,
                    cache: false,
                    href: '@Url.Action("GetProduct", "OrderProduct")' + "/" + row.Id,
                    onLoad: function () {
                        $('#order').datagrid('fixDetailRowHeight', index);
                    }
                });
                $('#order').datagrid('fixDetailRowHeight', index);
            }
        });

        $('#oldmail').datagrid({
            url: '@Url.Action("GetOldMail", "EbayMessageRe")/@Model.SenderName'

        });

        $('#dd').dialog('close');

    });
    function getOrderDate(v, r, i) {
        var html = "";
        html += "同:<b>" + getDate(r.CreateOn) + "</b>";
        if (r.ScanningBy != "")
            html += "<br/>扫:" + getDate(r.ScanningOn);
        return html;
    }

    function GetAmount(v, r, i) {
        var html = v + ":" + r.Amount;
        return html;
    }

    function GetBuyer(v, r, i) {
        var html = v + "<br />" + r.BuyerEmail;
        return html;
    }

    function getAccount(v, r, i) {

        var html = v + "<br />" + r.Platform;
        return html;
    }

    function GetOrder(v, r, i) {
        return v + "<br/>" + r.OrderExNo;
    }

    function GeStatus(v, r, i) {
        var html = v + "<br/>";
        if (r.IsPrint >= 1)
            html += "<img src='/Content/imgs/Print.gif'> ";
        if (r.IsMerger == 1)
            html += "<img src='/Content/imgs/Merger.gif'> ";
        if (r.IsSplit == 1)
            html += "<img src='/Content/imgs/Split.gif'> ";
        if (r.IsOutOfStock == 1)
            html += "<img src='/Content/imgs/OutOfStock.gif'> ";
        if (r.IsRepeat == 1)
            html += "<img src='/Content/imgs/Repeat.gif'> ";
        return html;
    }

    function send(t) {
        if ($('#c_BodyRe').attr("value") == "") {
            alert("回复顶不能为空！");
        }
        else {
            if ("@Model.IsReplay" == 1) {
                $.messager.confirm('确认', '该邮件已经回复过，是否进入再次回复?', function (r) {
                    if (r) {
                        sendtoto(t);
                    }
                });
            }
            else {
                sendtoto(t);
            }

        }
    }

    function EditProcessed() {
        $.ajax({
            type: 'post',
            url: "@Url.Action("EditProcessed", "AliMessage")/",
            data: "Id=@Model.Id",
            success: function (result) {
                alert("标记成功!");
                window.close();
            }
        });
    }
    function sendtoto(t) {
        $.ajax({
            url: '@Url.Action("Edit", "AliMessage")',
            data: "m=@Model.Id&c=" + $('#c_BodyRe').val(),
            type: 'post',
            success: function (result) {
                if (t == 1) {
                    if (result.Next != '0' && 'undefined' != result.Next) {
                        alert("回复完毕，点击“确定”进入下一封！");
                        window.location = "/AliMessage/Edit/" + result.Next;
                    } else {
                        alert("已经到最后一封未读，点击“确定”关闭！");
                        window.close();
                    }
                }
                else {
                    alert("回复完毕");
                }
            }
        });
    }

</script>
<body>
    <div class="easyui-layout" style="width: 100%; height: 1500px;">
        <div data-options="region:'north'" style="height: 400px">
            <div style="background-color: lightgray">
                <p>
                    &nbsp;&nbsp;&nbsp;&nbsp;账号:&nbsp;@Model.Shop

                    提问时间:&nbsp;@Model.CreateOn &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;店铺名称:&nbsp;@Model.Shop&nbsp;
                </p>
                <p>
                    &nbsp;&nbsp;&nbsp;&nbsp;类型:&nbsp;@Model.MessageType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@if (Model.MessageType == "order")
                                                                                                     {
                        <a href="@Model.OrderUrl" target="_blank">@Model.OrderId</a>
                                                                                                     }
                                                                                                     else if (Model.MessageType == "product")
                                                                                                     {
                        <a href="@Model.ProductUrl" target="_blank">@Model.TypeId</a>
                                                                                                     }
                </p>

            </div>
            <div>
                <table>

                    <tr>
                        <td valign="top">&nbsp;&nbsp;邮件内容:
                        </td>
                        <td colspan="9" valign="top">
                            <div style="height: 300px; overflow-y: auto; width: 1200px;" id="r-div">


                                @if (!string.IsNullOrEmpty(Model.OrderId) && Model.MessageType == "order")
                                {
                                    List<KeWeiOMS.Domain.AliMessageType> messages = ViewData["messages"] as List<KeWeiOMS.Domain.AliMessageType>;

                                    foreach (KeWeiOMS.Domain.AliMessageType item in messages)
                                    {
                                    <dl class="message-list-item">
                                        <dt>@item.SenderName</dt>
                                        <dd>
                                            <div class="date">@item.CreateOn</div>
                                            <div class="msg-content">
                                                <pre>@item.Content</pre>
                                                @if (@item.HaveFile)
                                                {
                                                    <a href="@item.FileUrl" target="_blank">包含文件</a>
                                                }
                                            </div>
                                        </dd>
                                    </dl>
                                    }
                                }
                                else
                                {
                                    @Model.Content
                                }

                            </div>

                        </td>
                    </tr>
                </table>
            </div>
        </div>




        <div data-options="region:'center',iconCls:'icon-ok'">
            @using (Html.BeginForm("Create", "EbayMessageRe", FormMethod.Post, new { id = "c_form" }))
            {
                <fieldset style="border: 0">
                    <table class="editForm">

                        <tr>
                            <td>
                                @Html.LabelFor(model => model.ReplayContent, "回复内容:")
                            </td>
                            <td>
                                @Html.TextAreaFor(model => model.ReplayContent, new { @id = "c_BodyRe", style = "width:700px;height:150px;resize:none; font-size: 12px;" })
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td align="center">
                                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls='icon-ok' onclick="send(0)">回复</a>
                                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls='icon-ok' onclick="send(1)">回复并进入下一封未读</a>

                                <a href="javascript:void(0)" class="easyui-linkbutton" iconcls='icon-ok' onclick="EditProcessed()">标记已处理</a>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            }
            <fieldset>
                <legend>关联订单</legend>
                <table id="order" style="width: 1000px; height: 150px">
                    <thead>
                        <tr>
                            <th field="OrderNo" width="100" formatter="GetOrder">订单编号
                            </th>
                            <th field="Status" width="150" formatter="GeStatus">订单状态
                            </th>
                            <th field="CurrencyCode" width="100" formatter="GetAmount">货币
                            </th>
                            <th field="BuyerName" width="130" formatter="GetBuyer">买家
                            </th>
                            <th field="Country" width="80">国家
                            </th>
                            <th field="LogisticMode" width="100">发货方式
                            </th>
                            <th field="TrackCode" width="100">Code
                            </th>
                            <th field="Weight" width="100">Weight
                            </th>
                            <th field="GenerateOn" width="200" formatter="getDate">时间
                            </th>
                            <th field="Account" width="120" formatter="getDate">Account
                            </th>
                        </tr>
                    </thead>
                </table>
            </fieldset>
        </div>
    </div>

</body>
